<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Les utilitaires &mdash; openMairie - Guide du développeur v0.0 documentation</title>
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/translations.js"></script>
    <link rel="top" title="openMairie - Guide du développeur v0.0 documentation" href="../index.html" />
    <link rel="up" title="<no title>" href="index.html" />
    <link rel="next" title="Importer des données en csv" href="import.html" />
    <link rel="prev" title="L’ergonomie" href="ergonomie.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="Index général"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="import.html" title="Importer des données en csv"
             accesskey="N">suivant</a> |</li>
        <li class="right" >
          <a href="ergonomie.html" title="L’ergonomie"
             accesskey="P">précédent</a> |</li>
        <li><a href="../index.html">openMairie - Guide du développeur v0.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">&lt;no title&gt;</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="les-utilitaires">
<span id="utilitaire"></span><h1>Les utilitaires<a class="headerlink" href="#les-utilitaires" title="Lien permanent vers ce titre">¶</a></h1>
<p>Les méthodes spécifiques à l&#8217;application sont dans obj/utils.class.php
qui héritent de la class om_application.class.php d &#8216;openmairie</p>
<p>Vous pouvez surcharger les classes d&#8217;om_application.class.php dans utils.class.php</p>
<p>Exemple : surcharge de la méthode login() pour conserver le service d&#8217;un utilisateur
en variable session dans openCourrier.</p>
<p>Ces classes contiennent les méthodes utilisées par le framework mais
qui peuvent vous aider à développer les scripts complémentaires de votre application.</p>
<p>Les scripts complémentaires peuvent être créer pour :</p>
<ul class="simple">
<li>faire un traitement en répertoire trt/ (remise à 0 d&#8217;un registre, archivage, export ....)</li>
<li>faire un sous programme spécifique en spg/ appellé par un formulaire (bible.php dans openCourrier)</li>
<li>faire une recherche avec un affichage particulier en scr/.</li>
</ul>
<div class="section" id="le-tutorial">
<h2>Le tutorial<a class="headerlink" href="#le-tutorial" title="Lien permanent vers ce titre">¶</a></h2>
<p>Il est proposé ici de vous montrer comment réaliser ce script complémentaire</p>
<p>Le script commence obligatoirement par un appel à la bibliothèque utils.class.php et la creation d un objet $f:</p>
<div class="highlight-python"><pre>require_once "../obj/utils.class.php";
$f = new utils(NULL,
            "courrier",
            _("recherche"),
            "ico_recherche.png",
            "recherche");</pre>
</div>
<p>Les parametres de l&#8217;objet sont les suivants :</p>
<blockquote>
<p>flag : si flag= Null affichage complete</p>
<blockquote>
<p>nonhtml : pas d affichage</p>
<p>htmlonly : tout les elements externes html avec body vide</p>
</blockquote>
<p>right : droit géré en om_droit - vide ne verifie pas</p>
<p>title : titre affiché</p>
<p>icon  : icone affiché</p>
<p>help  : aide affiché</p>
</blockquote>
<p>utils.class.php fait la Verification si l utilisateur est authentifié et si l utilisateur a le droit</p>
<p>Si le paramétre &#8220;right&#8221; est vide vous pouvez faire appel aux méthodes suivantes</p>
<div class="highlight-python"><pre>isAccredited() // a le droit ou pas
isAuthentified // si non authentifié, il est rejeté

$f-&gt;setRight($obj); // affecte un droit d acces
$f-&gt;isAuthorized(); //verification que l utilisateur accéde

// Affectation des variables en dehors du constructeur
$f-&gt;setTitle($ent);
$f-&gt;setIcon($ico);
$f-&gt;setHelp($obj);
$f-&gt;setFlag(NULL);

// affichage
$f-&gt;display();</pre>
</div>
<p>Pour <strong>executer une requête dans un fichier sql</strong> vous devez stocker
votre requête dans le répertoire sql/type_de_sgbd/nom_de_requete.inc
afin de préserver la portabilité de vos travaux sur d&#8217;autres sgbd:</p>
<div class="highlight-python"><pre>// appel au fichier requête
include ("../sql/".$f-&gt;phptype."/courrier_scr.inc");

// lancement de la requete sql_courrier et test erreur
$res=$f-&gt;db-&gt;query($sql_courrier);
$f-&gt;isDatabaseError($res);</pre>
</div>
<p>Pour <strong>parcourir les enregistrements</strong> vous utilisez les méthodes dbpear suivantes:</p>
<div class="highlight-python"><pre>// du debut à la fin de la requête
while ($row=&amp; $res-&gt;fetchRow(DB_FETCHMODE_ASSOC)){
    // j'affiche le champ courrier
     echo $row['courrier'];

}</pre>
</div>
<p>Pour <strong>ecrire dans la base</strong> vous pouvez utiliser les méthodes insert ou update
mais vous pouvez utilisez la méthode autoexecute spécifique à db pear:</p>
<p><em>requête sql</em></p>
<div class="highlight-python"><pre>$sql = "INSERT INTO ... ";

$res2 = $f -&gt; db -&gt; query($sql);

$f-&gt;isDatabaseError($res2);</pre>
</div>
<p><em>ou avec un tableau $valF</em></p>
<div class="highlight-python"><pre>$obj = table

$valF[$obj]=$f-&gt; db -&gt; nextId(DB_PREFIXE.$obj);

$res1= $f-&gt; db -&gt; autoExecute(DB_PREFIXE.$obj,$valF,DB_AUTOQUERY_INSERT);

$f-&gt;isDatabaseError($res1);</pre>
</div>
<p>Vous pouvez faire une <strong>Description du role de la page</strong> de la manière suivante</p>
<div class="highlight-python"><pre>$description = _("Cette page vous permet de .. ");

$f-&gt;displayDescription($description);</pre>
</div>
<p>Un <strong>message d erreur</strong> s&#8217;affiche suivant :</p>
<blockquote>
<p>$class : qui est la classe css qui s&#8217;affiche sur l&#8217;element et qui peut être</p>
<blockquote>
<p>&#8220;error&#8221; : pour le message erreur</p>
<p>&#8220;valid&#8221; : pour le message de validation</p>
</blockquote>
</blockquote>
<p>le <em>code</em> est le suivant</p>
<div class="highlight-python"><pre>$message = _("Mot de passe actuel incorrect");
$f-&gt;displayMessage($class, $message);</pre>
</div>
<p>Pour afficher  un <strong>fieldset</strong>, le code est le suivant</p>
<div class="highlight-python"><pre>echo "&lt;fieldset class=\"cadre ui-corner-all ui-widget-content\"&gt;\n";

echo "\t&lt;legend class=\"ui-corner-all ui-widget-content ui-state-active\"&gt;";

echo _("Courrier")."&lt;/legend&gt;";
    ...
echo "&lt;/fieldset&gt;</pre>
</div>
<p>il peut être par défqut <em>ouvert</em></p>
<div class="highlight-python"><pre>echo "&lt;fieldset class= ... collapsible\"&gt;\n";</pre>
</div>
<p>ou il peut être <em>fermé</em></p>
<div class="highlight-python"><pre>echo "&lt;fieldset ... startClosed\"&gt;\n";</pre>
</div>
<p>Vous pouvez faire <strong>appel a des scripts js complementaires</strong> en utilisant la méthode</p>
<div class="highlight-python"><pre>$f-&gt;addHTMLHeadJs(array("../js/formulairedyn.js", "../js/onglet.js"));</pre>
</div>
<p>Pour la <strong>gestion des accents</strong>, il est conseillé de ne pas mettre d accent dans
le code (utf8 au lieu de latin1-iso8859-1) et de mettre les accents dans la traduction</p>
<p>Pour définir le chemin par défaut pour l&#8217; ** upload de fichier**, il faut utiliser la méthode</p>
<div class="highlight-python"><pre>$path=$f-&gt;getPathFolderTrs()</pre>
</div>
</div>
<div class="section" id="exemple">
<h2>Exemple<a class="headerlink" href="#exemple" title="Lien permanent vers ce titre">¶</a></h2>
<p>Il est proposé de prendre l&#8217;exemple du traitement de la remise du registre
a 0 dans openCourrier</p>
<div class="highlight-python"><pre>// ENTETE NORMALISEE

/**
 * Cette page permet de remettre a 0 le registre
 *
 * @package openmairie_exemple
 * @version SVN : $Id: xxxx.php 311 2010-12-06 11:43:36Z xxxxx $
 */


// CREATION DE L' OBJET $f

require_once "../obj/utils.class.php";
$f = new utils(NULL, "traitement", _("remise a 0 du registre"), "ico_registre.png", "recherche");



// get
if (isset ($_GET['validation'])){
   $validation=$_GET['validation'];
}else{
   $validation=0;
}


/**
 * Description de la page
 */

$description = _("Cette page vous permet de remettre a 0 le numero de registre ".
                 "Ce traitement est a faire en debut d annee.");
$f-&gt;displayDescription($description);


// TEST VALIDATION
// SI = 0 affichage du numero de registre
// SI = 1 mise à 0 du registre et affichage du résultat

if($validation==0){
    $validation=1;

    // REQUETE DU REGISTRE

    $sql= "select id from registre_seq" ;
    $res1=$f-&gt;db-&gt;getOne($sql);
    $f-&gt;isDatabaseError($res1);

    // AFFICHAGE DANS UN FIELDSET

    echo "&lt;fieldset class=\"cadre ui-corner-all ui-widget-content\"&gt;\n";
    echo "\t&lt;legend class=\"ui-corner-all ui-widget-content ui-state-active\"&gt;";
    echo _("Registre ")."&lt;/legend&gt;";
    if ($res1!=0){
        echo "&lt;br&gt;"._("le dernier no du registre est")." : &amp;nbsp;&amp;nbsp;".$res1."&amp;nbsp;&amp;nbsp;";
    }else{
        echo "&lt;br&gt;"._("vous avez deja fait une remise a 0")."&lt;br&gt;";
    }
    echo "&lt;form method=\"POST\" action=\"num_registre.php?validation=".
    $validation."\" name=f1&gt;";
    echo "&lt;/fieldset&gt;";

    // BOUTON DE VALIDATION
    echo "\t&lt;div class=\"formControls\"&gt;";
    echo "&lt;input type='submit' value='"._("remise a 0 du registre").
          "&amp;nbsp;' &gt;";
    echo "&lt;/div&gt;";
    echo "&lt;/form&gt;";

}else { // validation=1

    // VALORISATION DE $valF
    $valF=array();
    $valF['id']=0;

    // REQUETE MISE A JOUR avec autoExecute
    $res2= $f-&gt;db-&gt;autoExecute("registre_seq",$valF,DB_AUTOQUERY_UPDATE);
    $f-&gt;isDatabaseError($res2);

    // AFFICHAGE DU RESULTAT AVEC UN FIELDSET
    echo "&lt;fieldset class=\"cadre ui-corner-all ui-widget-content\"&gt;\n";
    echo "\t&lt;legend class=\"ui-corner-all ui-widget-content ui-state-active\"&gt;";
    echo _("Registre ")."&lt;/legend&gt;";
    echo "&lt;center&gt;&lt;b&gt;"._("remise a 0 du registre reussie")."&lt;/b&gt;&lt;/center&gt;";
    echo "&lt;/fieldset&gt;";

}//validation</pre>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="../index.html">Table des matières</a></h3>
            <ul>
<li><a class="reference external" href="">Les utilitaires</a><ul>
<li><a class="reference external" href="#le-tutorial">Le tutorial</a></li>
<li><a class="reference external" href="#exemple">Exemple</a></li>
</ul>
</li>
</ul>

            <h4>Sujet précédent</h4>
            <p class="topless"><a href="ergonomie.html"
                                  title="Chapitre précédent">L&#8217;ergonomie</a></p>
            <h4>Sujet suivant</h4>
            <p class="topless"><a href="import.html"
                                  title="Chapitre suivant">Importer des données en csv</a></p>
            <h3>Cette page</h3>
            <ul class="this-page-menu">
              <li><a href="../_sources/framework/utilitaire.txt"
                     rel="nofollow">Montrer la source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Recherche rapide</h3>
              <form class="search" action="../search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="Index général"
             >index</a></li>
        <li class="right" >
          <a href="import.html" title="Importer des données en csv"
             >suivant</a> |</li>
        <li class="right" >
          <a href="ergonomie.html" title="L’ergonomie"
             >précédent</a> |</li>
        <li><a href="../index.html">openMairie - Guide du développeur v0.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >&lt;no title&gt;</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2010, openMairie.
      Créé avec <a href="http://sphinx.pocoo.org/">Sphinx</a> 0.6.2.
    </div>
  </body>
</html>